from fastapi import FastAPI, WebSocket
from typing import List

# Создаем экземпляр нашего сервера
app = FastAPI()

# --- Наше "хранилище" активных подключений ---
# Это простой список, куда мы будем складывать все активные WebSocket-соединения
# В реальном приложении здесь была бы сложная логика с пользователями,
# но для начала этого достаточно.
active_connections: List[WebSocket] = []

# -------------------------------------------------------------------
# --- НОВЫЙ ОБРАБОТЧИК: для WebSocket-соединений ---
# -------------------------------------------------------------------
# @app.websocket("/ws") - это означает, что данный "коридор" будет доступен
# по адресу ws://127.0.0.1:8000/ws
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    # --- 1. Прием нового подключения ---
    await websocket.accept() # "Впускаем" нового клиента (наше Kivy-приложение)
    active_connections.append(websocket) # Добавляем его в наш список активных
    print(f"Новое подключение! Всего активных: {len(active_connections)}")

    try:
        # --- 2. Бесконечный цикл для прослушивания сообщений ---
        # Сервер будет "висеть" в этом цикле, пока клиент подключен
        while True:
            # Ждем, пока клиент пришлет сообщение (в виде текста)
            data = await websocket.receive_text()
            print(f"Получено сообщение: {data}")

            # --- 3. Рассылка сообщения всем подключенным клиентам ---
            # Мы проходим по всем соединениям в нашем списке...
            for connection in active_connections:
                # ...и отправляем им полученные данные
                await connection.send_text(f"Сообщение от клиента: {data}")

    # --- 4. Обработка отключения ---
    except Exception as e:
        # Этот блок сработает, когда клиент отключится (например, закроет приложение)
        print(f"Клиент отключился. Ошибка: {e}")
    finally:
        # В любом случае удаляем его из списка активных
        active_connections.remove(websocket)
        print(f"Соединение закрыто. Всего активных: {len(active_connections)}")

